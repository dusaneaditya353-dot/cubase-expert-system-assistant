name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      run: |
        cd backend
        pytest tests/ -v --cov=. --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend

  frontend-build:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Lint
      run: |
        cd frontend
        npm run lint
    
    - name: Build
      run: |
        cd frontend
        npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-build]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install backend dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Start backend server
      run: |
        cd backend
        python main.py &
        sleep 5
    
    - name: Test API health
      run: |
        curl -f http://localhost:8000/health || exit 1

  create-release-artifact:
    name: Create Release Artifact
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download frontend build
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
    
    - name: Create release archive
      run: |
        zip -r cubase-expert-system-${{ github.sha }}.zip \
          backend/ \
          frontend/dist/ \
          knowledge-base/ \
          README.md \
          INSTALLATION.md \
          API_DOCS.md \
          LICENSE \
          -x "*.pyc" "**/__pycache__/*" "**/node_modules/*" "**/.git/*"
    
    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: cubase-expert-system-${{ github.sha }}.zip
